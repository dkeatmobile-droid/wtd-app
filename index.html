<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>WTD Working Time Tracker (Beta) — Single Page</title>

  <style>
    :root{
      --page:#e5e7eb;
      --text:#0f172a;

      --header1:#0b1220;
      --header2:#0f172a;
      --header3:#111827;

      --glass1: rgba(255,255,255,.74);
      --glass2: rgba(255,255,255,.56);
      --glassBorder: rgba(255,255,255,.62);

      --shadowSoft: 0 12px 28px rgba(2,6,23,.10);

      --segBg: rgba(255,255,255,.55);
      --segBorder: rgba(15,23,42,.08);
      --segThumb: rgba(255,255,255,.92);
      --segText: rgba(15,23,42,.70);
      --segTextOn: rgba(15,23,42,.98);

      --danger:#b00020;

      --ok:#16a34a;
      --warn:#f59e0b;
      --due:#ef4444;
      --lampOff:#6b7280;

      --radiusSheet: 28px;
      --radius: 18px;

      --rowH: 42px;
    }

    *{ box-sizing:border-box; }
    html,body{
      height:100%;
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background: var(--page);
      color: var(--text);
      overflow:hidden;
    }

    .app{
      height:100vh;
      height:100svh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      position:relative;
    }

    /* =========================
       Header
       ========================= */
    header{
      padding: calc(12px + env(safe-area-inset-top)) 14px 12px;
      color:#fff;
      background:
        radial-gradient(900px 260px at 18% 0%, rgba(255,255,255,.10), rgba(255,255,255,0) 60%),
        radial-gradient(700px 240px at 80% 10%, rgba(255,255,255,.08), rgba(255,255,255,0) 55%),
        linear-gradient(180deg, var(--header1), var(--header2) 48%, var(--header3));
      box-shadow: 0 14px 34px rgba(2,6,23,.18);
      position:relative;
      z-index:3;
    }

    .headerRow{
      display:flex;
      gap:12px;
      align-items:flex-start;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
      padding-top:2px;
      min-width:0;
      flex:1;
    }
    .brand .title{
      font-weight:950;
      font-size:15px;
      line-height:1.1;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .status{
      font-size:12px;
      font-weight:850;
      opacity:.86;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .betaNote{
      margin-top:8px;
      font-size:11px;
      line-height:1.25;
      opacity:.86;
    }
    .betaNote strong{ font-weight:950; }

    /* =========================
       Traffic light
       ========================= */
    .signalWrap{
      display:flex;
      align-items:flex-start;
      gap:10px;
      flex: 0 0 auto;
    }

    .signalBox{
      width:64px;
      padding:8px;
      border-radius:22px;
      background:
        radial-gradient(80px 110px at 30% 18%, rgba(255,255,255,.08), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.22)),
        #0a0a0a;
      border: 1px solid rgba(255,255,255,.07);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.08),
        inset 0 -10px 22px rgba(0,0,0,.35),
        0 12px 28px rgba(0,0,0,.30);
    }

    .signal{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
    }

    .lamp{
      width:42px;
      height:42px;
      border-radius:999px;
      background: var(--lampOff);
      box-shadow: inset 0 12px 18px rgba(0,0,0,.62);
      border: 2px solid rgba(0,0,0,.55);
      position:relative;
      overflow:hidden;
    }
    .lamp::after{
      content:"";
      position:absolute;
      left:10px; top:9px;
      width:22px; height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.18);
      transform: rotate(-12deg);
    }

    .signalTextGrid{
      display:grid;
      grid-template-rows: var(--rowH) var(--rowH) var(--rowH);
      gap:8px;
      min-width: 120px;
      max-width: 150px;
    }
    .sigLabel{
      height: var(--rowH);
      display:flex;
      align-items:center;
      font-size:11px;
      font-weight:900;
      color: rgba(255,255,255,.96);
      text-shadow: 0 2px 12px rgba(0,0,0,.45);
      opacity:0;
      transform: translateX(-4px);
      transition: opacity .16s ease, transform .16s ease;
      white-space:normal;
      line-height:1.15;
    }

    .signalWrap[data-state="off"] .sigLabel{ opacity:0 !important; }
    .signalWrap[data-state="ok"]   .sigLabel.green,
    .signalWrap[data-state="warn"] .sigLabel.amber,
    .signalWrap[data-state="due"]  .sigLabel.red{
      opacity:1;
      transform: translateX(0);
    }

    .signalWrap[data-state="ok"] .lamp.green{
      background: var(--ok);
      box-shadow: inset 0 12px 18px rgba(0,0,0,.45), 0 0 18px rgba(22,163,74,.45);
    }
    @keyframes amberFlash { 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.30)} }
    .signalWrap[data-state="warn"] .lamp.amber{
      background: var(--warn);
      box-shadow: inset 0 12px 18px rgba(0,0,0,.45), 0 0 18px rgba(245,158,11,.45);
      animation: amberFlash 1s infinite;
    }
    .signalWrap[data-state="due"] .lamp.red{
      background: var(--due);
      box-shadow: inset 0 12px 18px rgba(0,0,0,.45), 0 0 18px rgba(239,68,68,.45);
    }

    /* =========================
       Timing pill
       ========================= */
    .islandWrap{
      padding: 10px 12px 0;
      margin-top: -8px;
      display:flex;
      justify-content:center;
      position:relative;
      z-index:2;
    }
    .dynamicIsland{
      width: min(520px, calc(100vw - 24px));
      border-radius: 999px;
      padding: 10px 14px;
      background:
        radial-gradient(220px 70px at 25% 15%, rgba(255,255,255,.16), rgba(255,255,255,0) 60%),
        radial-gradient(260px 90px at 75% 30%, rgba(255,255,255,.10), rgba(255,255,255,0) 70%),
        linear-gradient(180deg, rgba(30,41,59,.88), rgba(15,23,42,.92));
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow:
        0 18px 44px rgba(2,6,23,.26),
        inset 0 1px 0 rgba(255,255,255,.14),
        inset 0 -14px 30px rgba(0,0,0,.30);
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      align-items:center;
    }
    .dStat .k{
      font-size:10px;
      font-weight:950;
      letter-spacing:.25px;
      color: rgba(255,255,255,.72);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dStat .v{
      margin-top:2px;
      font-size:13px;
      font-weight:1000;
      color: rgba(255,255,255,.96);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* =========================
       Sheet
       ========================= */
    main{
      flex:1;
      min-height:0;
      padding: 10px 12px 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      overflow:hidden;
    }

    .sheet{
      height:100%;
      border-radius: var(--radiusSheet) var(--radiusSheet) 0 0;
      background: linear-gradient(180deg, var(--glass1), var(--glass2));
      border: 1px solid var(--glassBorder);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 -10px 40px rgba(2,6,23,.18);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .sheet::-webkit-scrollbar{ width:0; height:0; }

    .glass{
      background: linear-gradient(180deg, var(--glass1), var(--glass2));
      border: 1px solid var(--glassBorder);
      border-radius: var(--radius);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: var(--shadowSoft);
    }

    /* Buttons */
    .controlsRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }

    .btn{
      border:1px solid rgba(15,23,42,.10);
      border-radius: 18px;
      padding: 11px 10px;
      font-weight: 900;
      cursor:pointer;
      background: rgba(255,255,255,.80);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 10px 22px rgba(2,6,23,.08);
      color: rgba(15,23,42,.96);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .btn.primary{
      background: rgba(15,23,42,.92);
      color:#fff;
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 18px 40px rgba(2,6,23,.18);
    }
    .btn.primary.isRunning{ background: rgba(11,59,31,.92); }

    .btn.danger{
      color: var(--danger);
      border-color: rgba(176,0,32,.28);
      background: rgba(255,255,255,.78);
    }

    /* Segmented control */
    .strip{
      padding: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .seg{
      position:relative;
      display:inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: var(--segBg);
      border: 1px solid var(--segBorder);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 10px 20px rgba(2,6,23,.08);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .segThumb{
      position:absolute;
      top:3px; bottom:3px;
      left:3px;
      width: 40px;
      border-radius: 999px;
      background: var(--segThumb);
      box-shadow: 0 10px 18px rgba(2,6,23,.10);
      transition: transform 220ms ease, width 220ms ease;
      will-change: transform, width;
      pointer-events:none;
    }
    .segBtn{
      position:relative;
      z-index:1;
      border:0;
      background: transparent;
      padding: 9px 12px;
      font-size: 12px;
      font-weight: 900;
      color: var(--segText);
      cursor:pointer;
      border-radius: 999px;
      white-space:nowrap;
    }
    .segBtn.isOn{ color: var(--segTextOn); }

    .shiftLabel{
      font-size:11px;
      font-weight:900;
      color: rgba(15,23,42,.68);
      line-height:1.1;
      text-align:right;
      white-space:nowrap;
    }

    /* Single driver action button */
    .driverActionRow{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .btn.driverBig{
      padding: 18px 12px;
      font-size: 17px;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(2,6,23,.10);
    }
    .btn.driverBig.isOnBreak{
      background: rgba(245,158,11,.92);
      border-color: rgba(255,255,255,.18);
      color: rgba(0,0,0,.92);
      box-shadow: 0 18px 44px rgba(245,158,11,.18);
    }

    /* Dashboard */
    .dash{ display:flex; flex-direction:column; gap:10px; }

    .dashCard{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(520px 180px at 25% 18%, rgba(255,255,255,.10), rgba(255,255,255,0) 60%),
        radial-gradient(520px 200px at 78% 30%, rgba(255,255,255,.08), rgba(255,255,255,0) 70%),
        linear-gradient(180deg, rgba(30,41,59,.86), rgba(15,23,42,.92));
      box-shadow:
        0 18px 44px rgba(2,6,23,.22),
        inset 0 1px 0 rgba(255,255,255,.12),
        inset 0 -14px 30px rgba(0,0,0,.26);
      color: rgba(255,255,255,.94);
      overflow:hidden;
    }

    .dashMain{
      padding: 14px 14px 12px;
      display:grid;
      grid-template-columns: 74px 1fr;
      gap:12px;
      align-items:center;
    }

    /* ✅ extracted from inline styles (left mini panel) */
    .dashIconPanel{
      width:64px;
      height:108px;
      border-radius:22px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.10);
      display:grid;
      place-items:center;
    }
    .dashIconStack{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
    }
    .miniDot{
      width:16px;
      height:16px;
      border-radius:999px;
      background: rgba(255,255,255,.18);
    }

    .dashMain .bigTitle{
      font-size: 22px;
      font-weight: 1000;
      letter-spacing:.6px;
      color: rgba(255,255,255,.92);
      text-transform: uppercase;
    }
    .dashMain .bigTime{
      margin-top: 6px;
      font-size: 72px;
      line-height: .95;
      font-weight: 1100;
      letter-spacing: 1px;
      font-variant-numeric: tabular-nums;
    }

    .dashSub{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      color: rgba(255,255,255,.74);
      font-weight: 850;
    }
    .dashLine{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: 16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dashLine .mono{ font-variant-numeric: tabular-nums; color: rgba(255,255,255,.92); }

    .warnIcon{
      width: 18px;
      height: 18px;
      display:inline-grid;
      place-items:center;
      border-radius:6px;
      background: rgba(245,158,11,.20);
      border: 1px solid rgba(245,158,11,.32);
      color: rgba(245,158,11,.95);
      font-size: 13px;
      flex:0 0 auto;
    }

    .cardHint{
      padding: 10px 14px 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: rgba(255,255,255,.70);
      font-size: 12px;
      font-weight: 900;
    }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .dashSmall{ padding: 12px 14px; }
    .dashSmall .k{
      font-size: 13px;
      font-weight: 950;
      letter-spacing:.4px;
      text-transform: uppercase;
      color: rgba(255,255,255,.78);
    }
    .dashSmall .vRow{
      margin-top: 10px;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      font-variant-numeric: tabular-nums;
    }
    .dashSmall .vRow.tight{ margin-top:8px; } /* ✅ extracted */
    .dashSmall .v{
      font-size: 34px;
      font-weight: 1100;
      color: rgba(255,255,255,.96);
    }
    .dashSmall .vSub{
      font-size: 18px;
      font-weight: 1000;
      color: rgba(255,255,255,.84);
      white-space:nowrap;
    }

    .metaLabel{
      font-size:13px;
      font-weight:950;
      color:rgba(255,255,255,.72);
    }
    .metaValue{
      font-size:18px;
      font-weight:1100;
      color:rgba(255,255,255,.92);
    }

    .progress{
      margin-top: 12px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.14);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.08);
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(245,158,11,.92), rgba(245,158,11,.70));
    }

    .dashMeta{
      padding: 12px 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .metaItem{
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .metaItem .mk{
      font-size: 12px;
      font-weight: 950;
      color: rgba(255,255,255,.70);
    }
    .metaItem .mv{
      margin-top:6px;
      font-size: 18px;
      font-weight: 1050;
      color: rgba(255,255,255,.94);
      font-variant-numeric: tabular-nums;
    }

    /* Manual add + log */
    h3{
      margin: 12px 2px 10px;
      font-size: 14px;
      color: rgba(15,23,42,.92);
    }

    .rowGrid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .field{ padding: 12px; border-radius: var(--radius); }

    label{
      display:block;
      font-size:12px;
      color: rgba(15,23,42,.62);
      margin-bottom:6px;
      font-weight: 950;
    }

    /* ✅ iOS Safari zoom fix: keep font-size >= 16px */
    input,select{
      width:100%;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.10);
      font-size:16px;
      background: rgba(255,255,255,.80);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      outline:none;
    }

    .rowBtns{ display:flex; gap:10px; flex-wrap:wrap; }

    .logList{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
    .logItem{ padding: 12px; border-radius: var(--radius); }
    .logItem .top{display:flex; justify-content:space-between; gap:10px; align-items:center;}

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius: 999px;
      font-size:12px;
      font-weight: 950;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.70);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .pill.work{background: rgba(59,130,246,.12); border-color: rgba(59,130,246,.22);}
    .pill.rest{background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.22);}
    .pill.qual{background: rgba(16,185,129,.12); border-color: rgba(16,185,129,.22);}

    .subtle{font-size:12px; color: rgba(15,23,42,.55);}

    /* iPhone fit */
    @media (max-height: 720px){
      main{padding: 8px 10px 10px; padding-bottom: calc(10px + env(safe-area-inset-bottom));}
      .sheet{padding:10px;}
      .controlsRow{gap:8px;}
      .btn{padding:10px 9px;}
      .dashMain .bigTime{ font-size: 62px; }
      .lamp{width:38px; height:38px;}
      .signalBox{width:60px; padding:7px;}
      :root{ --rowH: 38px; }
      .signalTextGrid{min-width:110px; max-width:130px;}
      .btn.driverBig{ padding: 16px 12px; font-size: 16px; }
      .dynamicIsland{ padding: 8px 12px; }
      .dStat .v{ font-size:12px; }
    }
    @media (max-height: 690px){
      .betaNote{display:none;}
    }
  </style>
</head>

<body>
<div class="app">

  <header>
    <div class="headerRow">
      <div id="signalWrap" class="signalWrap" data-state="off" aria-label="Compliance indicator">
        <div class="signalBox" aria-hidden="true">
          <div class="signal">
            <div class="lamp red"></div>
            <div class="lamp amber"></div>
            <div class="lamp green"></div>
          </div>
        </div>

        <div class="signalTextGrid" aria-hidden="true">
          <div class="sigLabel red">STOP — break required</div>
          <div class="sigLabel amber">Break upcoming</div>
          <div class="sigLabel green">Compliant</div>
        </div>
      </div>

      <div class="brand">
        <div class="title">WTD Working Time Tracker</div>
        <div id="headerStatus" class="status">Ready</div>
      </div>
    </div>

    <div class="betaNote">
      <strong>Not a driving hours tracker.</strong> Working time only.
      <strong>Beta:</strong> all times must be double-checked.
    </div>
  </header>

  <!-- Timing pill -->
  <div class="islandWrap" aria-label="Shift timing">
    <div class="dynamicIsland">
      <div class="dStat">
        <div class="k">Start time</div>
        <div id="hdrStart" class="v">—</div>
      </div>
      <div class="dStat">
        <div class="k">Duration</div>
        <div id="hdrDuration" class="v">00:00</div>
      </div>
      <div class="dStat">
        <div class="k">End time</div>
        <div id="hdrEnd" class="v">—</div>
      </div>
    </div>
  </div>

  <main>
    <div class="sheet">

      <div class="controlsRow">
        <button id="btnStartShift" class="btn primary" type="button">Start shift</button>
        <button id="btnEndShift" class="btn" type="button">End shift</button>
        <button id="btnResetDay" class="btn danger" type="button">Reset day</button>
      </div>

      <div class="glass strip" aria-label="Shift controls">
        <div class="shiftLabel">Length of shift<br/>for the day</div>
        <div class="seg" id="segShift" role="group" aria-label="Shift length">
          <div class="segThumb" aria-hidden="true"></div>
          <button class="segBtn" type="button" data-value="13">13h</button>
          <button class="segBtn" type="button" data-value="15">15h</button>
        </div>
      </div>

      <div class="driverActionRow">
        <button id="btnToggle" class="btn driverBig primary" type="button">Start break</button>
      </div>

      <div class="dash" aria-label="Driver dashboard">

        <!-- WORK SAFE FOR -->
        <div class="dashCard">
          <div class="dashMain">
            <div aria-hidden="true">
              <div class="dashIconPanel">
                <div class="dashIconStack">
                  <div id="miniLampTop" class="miniDot"></div>
                  <div id="miniLampMid" class="miniDot"></div>
                  <div id="miniLampBot" class="miniDot"></div>
                </div>
              </div>
            </div>

            <div>
              <div class="bigTitle">WORK SAFE FOR</div>
              <div id="uiWorkSafeFor" class="bigTime">—:—</div>

              <div class="dashSub">
                <div class="dashLine">
                  <span class="warnIcon">!</span>
                  <span id="uiBreakAt">Break required at —</span>
                </div>
                <div class="dashLine">
                  <span>Continuous work</span>
                  <span class="mono" id="uiContVsLimit">— / 06:00</span>
                </div>
              </div>
            </div>
          </div>

          <div class="cardHint">
            <div>Qualifying break counts at ≥ 15 min</div>
            <div id="uiShiftStartSmall">Shift start —</div>
          </div>
        </div>

        <!-- WTD TODAY + BREAK BUILDING -->
        <div class="twoCol">
          <div class="dashCard dashSmall">
            <div class="k">WTD TODAY</div>
            <div class="vRow">
              <div class="v" id="uiWtdToday">00:00</div>
              <div class="vSub" id="uiWtdLimit">/ 13:00</div>
            </div>
            <div class="vRow tight">
              <div class="metaLabel">Remaining</div>
              <div class="metaValue" id="uiWtdRemaining">—</div>
            </div>
            <div class="progress" aria-hidden="true">
              <div id="barWtd" class="bar"></div>
            </div>
          </div>

          <div class="dashCard dashSmall">
            <div class="k">BREAK BUILDING</div>
            <div class="vRow">
              <div class="v" id="uiBreakBuild">00</div>
              <div class="vSub">/ 15</div>
            </div>
            <div class="vRow tight">
              <div class="metaLabel">Last break</div>
              <div class="metaValue" id="uiLastRest">—</div>
            </div>
            <div class="progress" aria-hidden="true">
              <div id="barBreak" class="bar"></div>
            </div>
          </div>
        </div>

        <!-- Secondary details -->
        <div class="dashCard">
          <div class="dashMeta">
            <div class="metaItem">
              <div class="mk">Shift time</div>
              <div class="mv" id="uiShiftTime">00:00</div>
            </div>
            <div class="metaItem">
              <div class="mk">Break still needed</div>
              <div class="mv" id="uiRestNeeded">00:00</div>
            </div>
          </div>
        </div>

      </div>

      <h3>Manual add segment</h3>

      <div class="glass field">
        <label for="manType">Type</label>
        <select id="manType">
          <option value="WORK">WORK</option>
          <option value="REST">BREAK</option>
        </select>
      </div>

      <div class="rowGrid2">
        <div class="glass field">
          <label for="manStart">Start time</label>
          <input id="manStart" inputmode="tel" placeholder="08:00" />
          <div class="subtle" style="margin-top:6px;">Auto formats to HH:MM on iPhone</div>
        </div>

        <div class="glass field">
          <label for="manEnd">Finish time</label>
          <input id="manEnd" inputmode="tel" placeholder="09:15" />
        </div>
      </div>

      <div class="rowBtns">
        <button id="btnAddManual" class="btn primary" type="button">Add segment</button>
        <button id="btnDeleteLast" class="btn" type="button">Delete last</button>
      </div>

      <div class="subtle">
        Times use today’s date. If end is earlier than start, it is treated as next day.
      </div>

      <h3>Segment log</h3>
      <div id="logList" class="logList"></div>

    </div>
  </main>
</div>

<script>
(() => {
  const STORAGE_KEY = "wtd_single_page_driver_v3";
  const MIN  = 60000;
  const HOUR = 60 * MIN;

  const defaults = () => ({
    shiftHours: 13,
    shiftStartMs: null,
    currentType: null, // "WORK" | "REST" | null (REST == BREAK in UI)
    segments: []       // {type,startMs,endMs}
  });

  let state = load();
  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaults();
      const parsed = JSON.parse(raw);
      return { ...defaults(), ...parsed };
    }catch{
      return defaults();
    }
  }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  // DOM
  const signalWrap = document.getElementById("signalWrap");
  const headerStatus = document.getElementById("headerStatus");

  // Timing pill
  const hdrStart = document.getElementById("hdrStart");
  const hdrDuration = document.getElementById("hdrDuration");
  const hdrEnd = document.getElementById("hdrEnd");

  const btnStartShift = document.getElementById("btnStartShift");
  const btnEndShift   = document.getElementById("btnEndShift");
  const btnResetDay   = document.getElementById("btnResetDay");
  const btnToggle = document.getElementById("btnToggle");

  const segShift = document.getElementById("segShift");

  // Driver dashboard fields
  const uiWorkSafeFor     = document.getElementById("uiWorkSafeFor");
  const uiBreakAt         = document.getElementById("uiBreakAt");
  const uiContVsLimit     = document.getElementById("uiContVsLimit");
  const uiShiftStartSmall = document.getElementById("uiShiftStartSmall");

  const uiWtdToday        = document.getElementById("uiWtdToday");
  const uiWtdLimit        = document.getElementById("uiWtdLimit");
  const uiWtdRemaining    = document.getElementById("uiWtdRemaining");
  const barWtd            = document.getElementById("barWtd");

  const uiBreakBuild      = document.getElementById("uiBreakBuild");
  const uiLastRest        = document.getElementById("uiLastRest");
  const barBreak          = document.getElementById("barBreak");

  const uiShiftTime       = document.getElementById("uiShiftTime");
  const uiRestNeeded      = document.getElementById("uiRestNeeded");

  const miniLampTop       = document.getElementById("miniLampTop");
  const miniLampMid       = document.getElementById("miniLampMid");
  const miniLampBot       = document.getElementById("miniLampBot");

  // Manual + log
  const manType = document.getElementById("manType");
  const manStart = document.getElementById("manStart");
  const manEnd = document.getElementById("manEnd");
  const btnAddManual = document.getElementById("btnAddManual");
  const btnDeleteLast = document.getElementById("btnDeleteLast");
  const logList = document.getElementById("logList");

  const pad2 = (n) => String(n).padStart(2,"0");
  const clamp0 = (ms) => Math.max(0, ms);

  function fmtDur(ms){
    const totalMin = Math.max(0, Math.floor(ms / MIN));
    const hh = Math.floor(totalMin / 60);
    const mm = totalMin % 60;
    return `${pad2(hh)}:${pad2(mm)}`;
  }
  function fmtTime(ms){
    const d = new Date(ms);
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }
  function haptic(ms=10){
    try{ if(navigator.vibrate) navigator.vibrate(ms); } catch {}
  }
  function isRunning(){ return !!state.shiftStartMs; }

  // iPhone-friendly time input: 0800 -> 08:00
  function autoColon(el){
    if(!el) return;
    el.addEventListener("input", () => {
      let v = (el.value || "").replace(/[^\d]/g,"").slice(0,4);
      if(v.length >= 3) v = v.slice(0,2) + ":" + v.slice(2);
      el.value = v;
    });
  }
  autoColon(manStart);
  autoColon(manEnd);

  function makeSegmented(segEl, initialValue, onChange){
    const thumb = segEl.querySelector(".segThumb");
    const btns = Array.from(segEl.querySelectorAll(".segBtn"));

    function moveTo(btn){
      const segRect = segEl.getBoundingClientRect();
      const r = btn.getBoundingClientRect();
      const left = r.left - segRect.left;
      thumb.style.width = `${r.width}px`;
      thumb.style.transform = `translateX(${left}px)`;
    }

    function setValue(value){
      btns.forEach(b => b.classList.toggle("isOn", b.dataset.value === String(value)));
      const active = btns.find(b => b.classList.contains("isOn")) || btns[0];
      moveTo(active);
    }

    btns.forEach(btn => {
      btn.addEventListener("click", () => {
        haptic(8);
        const v = btn.dataset.value;
        setValue(v);
        onChange(v);
      });
    });

    const ro = new ResizeObserver(() => {
      const active = btns.find(b => b.classList.contains("isOn")) || btns[0];
      moveTo(active);
    });
    ro.observe(segEl);

    requestAnimationFrame(() => setValue(initialValue));
    return { setValue };
  }

  // WTD-only logic:
  // - "Break due" when continuous WORK reaches 6h
  // - "Break required" totals: >6h => 30m, >9h => 45m (qualifying BREAK >= 15m)
  function resolvedSegments(now){
    return state.segments.map(s => ({...s, endMs: (s.endMs == null ? now : s.endMs)}));
  }
  function sumMs(segs, type){
    return segs.filter(s => s.type === type).reduce((a,s)=> a + clamp0(s.endMs - s.startMs), 0);
  }
  function qualifyingBreakMs(segs){
    return segs
      .filter(s => s.type === "REST")
      .reduce((acc, s) => {
        const d = clamp0(s.endMs - s.startMs);
        return acc + (d >= 15*MIN ? d : 0);
      }, 0);
  }
  function requiredBreakMs(workMs){
    if(workMs > 9*HOUR) return 45*MIN;
    if(workMs > 6*HOUR) return 30*MIN;
    return 0;
  }
  function continuousWorkMs(segs){
    let lastBreakEnd = null;
    for(const s of segs){
      if(s.type === "REST") lastBreakEnd = s.endMs;
    }
    if(lastBreakEnd == null) return sumMs(segs, "WORK");
    return segs
      .filter(s => s.type === "WORK" && s.endMs > lastBreakEnd)
      .reduce((acc, s) => {
        const start = Math.max(s.startMs, lastBreakEnd);
        return acc + clamp0(s.endMs - start);
      }, 0);
  }
  function nextBreakDueInMs(contWorkMs){ return 6*HOUR - contWorkMs; }

  function closeOpenSegment(now){
    const last = state.segments[state.segments.length - 1];
    if(last && last.endMs == null) last.endMs = now;
  }

  function startSegment(type){
    if(!isRunning()) return;
    if(state.currentType === type) return;
    const now = Date.now();
    closeOpenSegment(now);
    state.currentType = type;
    state.segments.push({ type, startMs: now, endMs: null });
    save();
    render();
  }

  function toggleWorkBreak(){
    if(!isRunning()) return;
    haptic(10);
    if(state.currentType === "REST"){
      startSegment("WORK");
    } else {
      startSegment("REST");
    }
  }

  function setTraffic(stateKey, text){
    signalWrap.dataset.state = stateKey;
    headerStatus.textContent = text;

    const off = "rgba(255,255,255,.18)";
    miniLampTop.style.background = off;
    miniLampMid.style.background = off;
    miniLampBot.style.background = off;

    if(stateKey === "due"){
      miniLampTop.style.background = "rgba(239,68,68,.95)";
    } else if(stateKey === "warn"){
      miniLampMid.style.background = "rgba(245,158,11,.95)";
    } else if(stateKey === "ok"){
      miniLampBot.style.background = "rgba(22,163,74,.95)";
    }
  }

  function parseTimeToMs(hhmm){
    const m = /^(\d{1,2}):(\d{2})$/.exec((hhmm||"").trim());
    if(!m) return null;
    const hh = Number(m[1]), mm = Number(m[2]);
    if(hh < 0 || hh > 23 || mm < 0 || mm > 59) return null;
    const d = new Date();
    d.setHours(hh, mm, 0, 0);
    return d.getTime();
  }

  function addManual(){
    const type = manType.value; // WORK or REST
    const s = parseTimeToMs(manStart.value);
    const e0 = parseTimeToMs(manEnd.value);
    if(s == null || e0 == null){
      alert("Enter times like 08:00 (or type 0800 and it will format).");
      return;
    }
    let e = e0;
    if(e <= s) e += 24*HOUR;
    state.segments.push({ type, startMs: s, endMs: e });
    state.currentType = null;
    save();
    render();
  }

  function deleteLast(){
    if(state.segments.length === 0) return;
    state.segments.pop();
    const last = state.segments[state.segments.length - 1];
    state.currentType = (last && last.endMs == null) ? last.type : null;
    save();
    render();
  }

  function renderLog(segs){
    if(!logList) return;
    if(segs.length === 0){
      logList.innerHTML = `<div class="subtle">No segments yet.</div>`;
      return;
    }
    const items = [...segs].sort((a,b)=> b.startMs - a.startMs);
    logList.innerHTML = items.map(s=>{
      const dur = clamp0(s.endMs - s.startMs);
      const isQual = s.type === "REST" && dur >= 15*MIN;
      const pillClass = s.type === "WORK" ? "work" : "rest";
      const label = s.type === "WORK" ? "WORK" : "BREAK";
      const qualPill = isQual ? `<span class="pill qual">QUAL</span>` : "";
      const t1 = fmtTime(s.startMs);
      const t2 = fmtTime(s.endMs);
      return `
        <div class="glass logItem">
          <div class="top">
            <div>
              <span class="pill ${pillClass}">${label}</span>
              ${qualPill}
            </div>
            <div class="subtle">${fmtDur(dur)}</div>
          </div>
          <div class="subtle" style="margin-top:8px;">${t1} → ${t2}</div>
        </div>
      `;
    }).join("");
  }

  function lastBreakSegment(segs){
    for(let i=segs.length-1; i>=0; i--){
      if(segs[i].type === "REST") return segs[i];
    }
    return null;
  }

  function updateToggleButton(running){
    btnToggle.disabled = !running;
    const onBreak = state.currentType === "REST";
    btnToggle.classList.toggle("isOnBreak", onBreak);
    btnToggle.textContent = onBreak ? "Resume work" : "Start break";
  }

  function render(){
    const now = Date.now();
    const running = isRunning();

    // Timing pill
    if(!running){
      hdrStart.textContent = "—";
      hdrDuration.textContent = "00:00";
      hdrEnd.textContent = "—";
    } else {
      hdrStart.textContent = fmtTime(state.shiftStartMs);
      hdrDuration.textContent = fmtDur(now - state.shiftStartMs);
      hdrEnd.textContent = fmtTime(state.shiftStartMs + (state.shiftHours * HOUR));
    }

    // Start/End buttons
    btnStartShift.classList.toggle("isRunning", running);
    btnStartShift.textContent = running ? "Shift running" : "Start shift";
    btnStartShift.disabled = running;

    btnEndShift.disabled = !running;
    updateToggleButton(running);

    if(!running){
      uiWorkSafeFor.textContent = "—:—";
      uiBreakAt.textContent = "Break required at —";
      uiContVsLimit.textContent = "— / 06:00";
      uiShiftStartSmall.textContent = "Shift start —";

      uiWtdToday.textContent = "00:00";
      uiWtdLimit.textContent = `/ ${pad2(state.shiftHours)}:00`;
      uiWtdRemaining.textContent = "—";
      barWtd.style.width = "0%";

      uiBreakBuild.textContent = "00";
      uiLastRest.textContent = "—";
      barBreak.style.width = "0%";

      uiShiftTime.textContent = "00:00";
      uiRestNeeded.textContent = "00:00";

      renderLog([]);
      setTraffic("off", "Ready");
      return;
    }

    const segs = resolvedSegments(now);

    const workMs = sumMs(segs, "WORK");
    const qualMs = qualifyingBreakMs(segs);
    const reqMs  = requiredBreakMs(workMs);
    const needMs = clamp0(reqMs - qualMs);

    const contMs = continuousWorkMs(segs);
    const dueInMs = nextBreakDueInMs(contMs);

    uiWorkSafeFor.textContent = fmtDur(Math.max(0, dueInMs));

    if(dueInMs <= 0){
      uiBreakAt.textContent = "Break required";
    } else {
      uiBreakAt.textContent = `Break required at ${fmtTime(now + dueInMs)}`;
    }

    uiContVsLimit.textContent = `${fmtDur(contMs)} / 06:00`;
    uiShiftStartSmall.textContent = `Shift start ${fmtTime(state.shiftStartMs)}`;
    uiShiftTime.textContent = fmtDur(now - state.shiftStartMs);

    uiWtdToday.textContent = fmtDur(workMs);
    uiWtdLimit.textContent = `/ ${pad2(state.shiftHours)}:00`;

    const remainingMs = Math.max(0, state.shiftHours * HOUR - workMs);
    uiWtdRemaining.textContent = fmtDur(remainingMs);

    const wtdPct = Math.min(100, Math.max(0, (workMs / (state.shiftHours * HOUR)) * 100));
    barWtd.style.width = `${wtdPct}%`;

    const lastBreak = lastBreakSegment(segs);
    let currentBreakMs = 0;
    if(state.currentType === "REST" && lastBreak){
      currentBreakMs = clamp0(lastBreak.endMs - lastBreak.startMs);
    }

    const breakBuildMin = Math.min(15, Math.floor(currentBreakMs / MIN));
    uiBreakBuild.textContent = pad2(breakBuildMin);
    uiLastRest.textContent = lastBreak ? fmtDur(clamp0(lastBreak.endMs - lastBreak.startMs)) : "—";

    const breakPct = Math.min(100, Math.max(0, (currentBreakMs / (15*MIN)) * 100));
    barBreak.style.width = `${breakPct}%`;

    uiRestNeeded.textContent = fmtDur(needMs);

    renderLog(segs);

    const warnThreshold = 15*MIN;
    if(dueInMs <= 0){
      setTraffic("due", "Break due (continuous work)");
    } else if(dueInMs <= warnThreshold){
      setTraffic("warn", `Break soon: ${fmtDur(dueInMs)}`);
    } else {
      setTraffic("ok", `Compliant: break in ${fmtDur(dueInMs)}`);
    }

    updateToggleButton(running);
  }

  const segShiftAPI = makeSegmented(segShift, String(state.shiftHours), (v) => {
    state.shiftHours = Number(v);
    save();
    render();
    requestAnimationFrame(() => segShiftAPI.setValue(String(state.shiftHours)));
  });

  btnStartShift.addEventListener("click", () => {
    if(isRunning()) return;
    haptic(12);
    state.shiftStartMs = Date.now();
    state.currentType = "WORK";
    state.segments = [{ type:"WORK", startMs: state.shiftStartMs, endMs: null }];
    save();
    render();
  });

  btnEndShift.addEventListener("click", () => {
    if(!isRunning()) return;
    haptic(12);
    closeOpenSegment(Date.now());
    state.shiftStartMs = null;
    state.currentType = null;
    save();
    render();
  });

  btnResetDay.addEventListener("click", () => {
    haptic(14);
    const ok = confirm("Reset day? This clears the shift and all segments.");
    if(!ok) return;
    state = defaults();
    save();
    render();
    segShiftAPI.setValue(String(state.shiftHours));
  });

  btnToggle.addEventListener("click", toggleWorkBreak);
  btnAddManual.addEventListener("click", () => { haptic(8); addManual(); });
  btnDeleteLast.addEventListener("click", () => { haptic(8); deleteLast(); });

  setInterval(render, 1000);
  render();
})();
</script>
</body>
</html>
