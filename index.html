<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>WTD Tracker</title>

  <style>
    :root{
      --bg:#070b14;
      --panel: rgba(255,255,255,.04);
      --panel2: rgba(255,255,255,.03);
      --text:#eaf1ff;
      --muted:#a9b7d6;

      --good:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;

      --primary: rgba(77,163,255,.35);
      --primaryBorder: rgba(77,163,255,.35);

      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.08);

      --shadow: 0 10px 26px rgba(0,0,0,.22);
      --shadow2: 0 6px 18px rgba(0,0,0,.18);

      --radius: 18px;

      /* NEW: green select */
      --selG1: rgba(34,197,94,.60);
      --selG2: rgba(34,197,94,.24);
      --selGB: rgba(34,197,94,.85);
      --selGOutline: rgba(34,197,94,.75);

      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 20% -10%, rgba(18,34,74,.85) 0%, rgba(7,11,20,1) 52%),
        var(--bg);
    }

    /* ===== Header ===== */
    header{
      position:sticky; top:0; z-index:20;
      border-bottom:1px solid var(--border2);
      box-shadow: 0 8px 22px rgba(0,0,0,.35);
      background: rgba(10,20,41,.82);
      backdrop-filter: blur(10px);
    }

    /* State-based header tone */
    body.state-ok header{ background: rgba(10,20,41,.82); animation:none; }
    body.state-warn header{ background: rgba(28,20,5,.85); animation: headerPulseSoft 2.8s ease-in-out infinite; }
    body.state-alert header{ background: rgba(28,5,10,.88); animation: headerPulseStrong 1.8s ease-in-out infinite; }

    .headerInner{
      max-width:960px;
      margin:0 auto;
      padding:16px 14px 14px;
      text-align:center;
      position:relative;
    }

    /* Subtle state accent line */
    .headerInner:after{
      content:"";
      position:absolute;
      left:14px; right:14px; bottom:-1px;
      height:2px;
      background: rgba(45,212,191,.55);
      border-radius:999px;
      opacity:.65;
    }
    body.state-warn .headerInner:after{ background: rgba(251,191,36,.60); }
    body.state-alert .headerInner:after{ background: rgba(251,113,133,.65); }

    .headerTitle{
      font-size:18px;
      font-weight:950;
      letter-spacing:.3px;
      margin:0;
    }
    .headerSub{
      margin-top:6px;
      font-size:12px;
      color:#9fb2d9;
    }
    .headerWarning{
      margin-top:6px;
      font-size:11px;
      color:var(--warn);
      font-weight:900;
    }

    /* Segmented switch */
    .segWrap{ display:flex; justify-content:center; margin-top:12px; }
    .seg{
      display:inline-flex;
      border:1px solid var(--border);
      background: rgba(7,11,20,.18);
      border-radius:999px;
      overflow:hidden;
      box-shadow: var(--shadow2);
    }
    .seg button{
      appearance:none;
      border:0;
      background:transparent;
      color:rgba(169,183,214,.9);
      padding:10px 14px;
      font-weight:900;
      letter-spacing:.2px;
      font-size:13px;
      min-width:140px;
      cursor:pointer;
    }
    .seg button.active{
      color:var(--text);
      background: rgba(255,255,255,.08);
    }
    .seg button:active{ transform: translateY(1px); }

    .pillRow{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--border2);
      border-radius:999px;
      background: rgba(7,11,20,.22);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:#64748b; }
    .dot.WORK{ background:var(--good); }
    .dot.BREAK{ background:var(--bad); }

    /* ===== Layout ===== */
    .wrap{ max-width:960px; margin:0 auto; padding:16px 14px 190px; }
    .grid{ display:grid; gap:14px; }

    .cards{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:14px; }
    @media(min-width:900px){ .cards{ grid-template-columns:repeat(4,minmax(0,1fr)); } }

    .card{
      border:1px solid var(--border2);
      border-radius:var(--radius);
      padding:14px;
      background: var(--panel);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    .card h3{
      margin:0 0 10px;
      font-size:12px;
      text-transform: uppercase;
      letter-spacing: .9px;
      color: rgba(169,183,214,.85);
      font-weight:950;
    }

    .muted{ font-size:12px; color:var(--muted); }
    .tiny{ font-size:11px; color:var(--muted); line-height:1.35; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .timer{
      font-variant-numeric: tabular-nums;
      letter-spacing: .6px;
    }
    .big{ font-size:22px; font-weight:950; letter-spacing:.3px; }
    .big2{ font-size:30px; font-weight:980; letter-spacing:.4px; }
    @media(max-width:420px){ .big2{ font-size:26px; } }

    /* Buttons */
    button{ font-family: inherit; }
    .btn{
      flex:1 1 150px;
      min-height:44px;
      padding:14px 12px;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color:var(--text);
      font-weight:950;
      font-size:15px;
      letter-spacing:.2px;
      box-shadow: 0 10px 22px rgba(0,0,0,.20);
      user-select:none;
      cursor:pointer;
      transition: transform .12s ease, background .2s ease, border-color .2s ease, opacity .2s ease, box-shadow .2s ease;
    }
    .btn:hover{ border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.065); }
    .btn:active{ transform: translateY(1px); }
    .btn:focus{ outline: 2px solid rgba(77,163,255,.55); outline-offset: 2px; }

    .btn.primary{
      background: linear-gradient(180deg, var(--primary), rgba(77,163,255,.18));
      border-color: var(--primaryBorder);
    }
    .btn.secondary{
      background: rgba(255,255,255,.03);
      box-shadow: 0 8px 18px rgba(0,0,0,.16);
    }
    .btn.danger{
      background: rgba(251,113,133,.14);
      border-color: rgba(251,113,133,.30);
    }

    .btn.WORK{ outline:2px solid rgba(45,212,191,.28); }
    .btn.BREAK{ outline:2px solid rgba(251,113,133,.28); }

    /* ===== NEW: Footer button “inactive grey glass” polish ===== */
    .footer .btn{
      background: rgba(255,255,255,.035);
      border-color: rgba(255,255,255,.12);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      backdrop-filter: blur(6px);
    }
    .footer .btn:hover{
      background: rgba(255,255,255,.055);
      border-color: rgba(255,255,255,.20);
    }

    /* ===== NEW: Selected mode = GREEN (hard override) ===== */
    #btnWork.modeSelected,
    #btnBreak.modeSelected{
      background: linear-gradient(180deg, var(--selG1), var(--selG2)) !important;
      border-color: var(--selGB) !important;
      color: #eafff2 !important;
      box-shadow: 0 14px 30px rgba(34,197,94,.22) !important;
      filter: none !important;
      opacity: 1 !important;
      transform: none !important;
      animation: none !important;
    }
    #btnWork.modeSelected:focus,
    #btnBreak.modeSelected:focus{
      outline: 2px solid var(--selGOutline) !important;
      outline-offset: 2px;
    }

    /* ===== NEW: Break button turns RED only when overdue (state-alert) ===== */
    body.state-alert #btnBreak:not(.modeSelected){
      background: linear-gradient(180deg, rgba(251,113,133,.65), rgba(225,29,72,.26)) !important;
      border-color: rgba(251,113,133,.78) !important;
      color: #fff !important;
    }

    /* Banner (status row) */
    .banner{
      position:relative;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px;
      border-radius:var(--radius);
      border:1px solid var(--border2);
      background: var(--panel2);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(6px);
    }
    .banner:before{
      content:"";
      position:absolute;
      left:10px; top:12px; bottom:12px;
      width:4px;
      border-radius:999px;
      background: rgba(45,212,191,.8);
      opacity:.85;
    }
    body.state-warn .banner:before{ background: rgba(251,191,36,.9); }
    body.state-alert .banner:before{ background: rgba(251,113,133,.9); }

    .statusGood{ color:var(--good); font-weight:900; }
    .statusWarn{ color:var(--warn); font-weight:900; }
    .statusBad{ color:var(--bad); font-weight:900; }

    /* Full-only sections */
    .fullOnly{ display:none; }
    body.full .fullOnly{ display:block; }

    /* Forms */
    .field{ display:grid; gap:6px; margin-top:10px; }
    label{ font-size:12px; color:var(--muted); font-weight:950; }
    input, select{
      background: rgba(11,18,32,.78);
      color:var(--text);
      border:1px solid var(--border2);
      border-radius:14px;
      padding:12px;
      font-size:14px;
      transition: border-color .2s ease, background .2s ease;
    }
    input:focus, select:focus{
      outline: none;
      border-color: rgba(77,163,255,.55);
      background: rgba(11,18,32,.88);
      box-shadow: 0 0 0 3px rgba(77,163,255,.16);
    }

    /* Table */
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); font-size:12px; }
    th{ color:var(--muted); text-align:left; font-weight:950; }
    td{ color:var(--text); }
    .right{ text-align:right; }

    table thead th{
      position: sticky;
      top: 0;
      background: rgba(11,18,32,.95);
      backdrop-filter: blur(6px);
      z-index: 1;
    }
    tbody tr:nth-child(even) td{ background: rgba(255,255,255,.02); }

    /* ===== Footer bar ===== */
    .footer{
      position:fixed; left:0; right:0; bottom:0; z-index:25;
      background: linear-gradient(180deg, rgba(7,11,20,.00) 0%, rgba(7,11,20,.92) 25%, rgba(7,11,20,.98) 100%);
      padding:12px 12px 14px;
      border-top:1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
      transition: transform .28s ease, box-shadow .28s ease;
    }
    .footer .row{ max-width:960px; margin:0 auto; }
    .footerNote{ max-width:960px; margin:8px auto 0; }

    /* Action bar movement + bounce (keep your “urgent” affordance, but less aggressive) */
    body.state-warn .footer{
      transform: translateY(-4px);
      box-shadow: 0 -10px 26px rgba(0,0,0,.32);
      animation: footerBounceSoft .45s ease;
    }
    body.state-alert .footer{
      transform: translateY(-8px);
      box-shadow: 0 -14px 32px rgba(0,0,0,.42);
      animation: footerBounceStrong .45s ease;
    }
    body.state-ok .footer{
      transform:none;
      box-shadow:none;
      animation:none;
    }

    /* ===== Animations ===== */
    @keyframes headerPulseSoft {
      0%   { box-shadow: 0 0 0 rgba(251,191,36,0.0); }
      50%  { box-shadow: 0 0 16px rgba(251,191,36,0.28); }
      100% { box-shadow: 0 0 0 rgba(251,191,36,0.0); }
    }
    @keyframes headerPulseStrong {
      0%   { box-shadow: 0 0 0 rgba(251,113,133,0.0); }
      50%  { box-shadow: 0 0 22px rgba(251,113,133,0.45); }
      100% { box-shadow: 0 0 0 rgba(251,113,133,0.0); }
    }
    @keyframes footerBounceSoft{
      0%   { transform: translateY(0); }
      35%  { transform: translateY(-10px); }
      60%  { transform: translateY(-4px); }
      100% { transform: translateY(-4px); }
    }
    @keyframes footerBounceStrong{
      0%   { transform: translateY(0); }
      35%  { transform: translateY(-16px); }
      60%  { transform: translateY(-8px); }
      100% { transform: translateY(-8px); }
    }

    /* ===== Break button urgency ===== */
    @keyframes breakGlowSoft {
      0%   { box-shadow: 0 0 0 rgba(251,191,36,0); }
      50%  { box-shadow: 0 0 18px rgba(251,191,36,.35); }
      100% { box-shadow: 0 0 0 rgba(251,191,36,0); }
    }
    @keyframes breakGlowStrong {
      0%   { box-shadow: 0 0 0 rgba(251,113,133,0); }
      50%  { box-shadow: 0 0 24px rgba(251,113,133,.55); }
      100% { box-shadow: 0 0 0 rgba(251,113,133,0); }
    }

    #btnBreak{ transition: transform .25s ease, box-shadow .25s ease; }

    /* IMPORTANT: don’t animate/scale if selected (green wins) */
    body.state-warn #btnBreak:not(.modeSelected){
      animation: breakGlowSoft 2.6s ease-in-out infinite;
      transform: scale(1.04);
      box-shadow: 0 8px 22px rgba(251,191,36,.24);
    }
    body.state-alert #btnBreak:not(.modeSelected){
      animation: breakGlowStrong 1.6s ease-in-out infinite;
      transform: scale(1.08);
      box-shadow: 0 10px 28px rgba(251,113,133,.32);
    }
    body.state-ok #btnBreak{
      animation:none;
      transform: scale(1);
      box-shadow: none;
    }

    /* Dim WORK button when break is needed */
    body.state-warn #btnWork{ opacity:.62; filter:saturate(.7); }
    body.state-alert #btnWork{ opacity:.45; filter:saturate(.55); transform:scale(.99); }
    body.state-ok #btnWork{ opacity:1; filter:none; transform:none; }

    /* ===== Emergency overlay (only in RED state) ===== */
    #emergencyOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
    }
    body.state-alert #emergencyOverlay{ display:flex; }

    .emCard{
      width:min(680px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(58,7,18,.92) 0%, rgba(28,5,10,.90) 100%);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding:18px;
    }
    .emTitle{ font-weight:980; letter-spacing:.6px; font-size:18px; }
    .emSub{ margin-top:6px; color:rgba(255,255,255,.78); font-size:13px; }
    .emStats{
      margin-top:14px;
      display:flex;
      gap:14px;
      justify-content:space-between;
      align-items:flex-end;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
    }
    .emLabel{ font-size:12px; color:rgba(255,255,255,.75); font-weight:900; }
    .emValue{ margin-top:4px; font-size:26px; font-weight:980; letter-spacing:.4px; font-variant-numeric: tabular-nums; }
    .emBreakBtn{
      margin-top:16px;
      width:100%;
      min-height:52px;
      padding:18px 16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(251,113,133,.95) 0%, rgba(225,29,72,.92) 100%);
      color:#fff;
      font-weight:980;
      font-size:18px;
      letter-spacing:.6px;
      box-shadow: 0 14px 40px rgba(225,29,72,.30);
      cursor:pointer;
    }
    .emBreakBtn:active{ transform: translateY(1px); }
    .emBreakBtn:focus{ outline: 2px solid rgba(255,255,255,.55); outline-offset: 2px; }
    .emHint{ margin-top:12px; font-size:11px; color:rgba(255,255,255,.70); line-height:1.35; }

    /* Reduce motion if requested */
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; }
    }
  </style>
</head>

<body class="state-ok">
  <header>
    <div class="headerInner">
      <div class="headerTitle">WTD Tracker</div>
      <div class="headerSub">Work &amp; Break Working Time Directive Tracker</div>
      <div class="headerWarning">This is a beta app — times must be double checked.</div>

      <div class="segWrap" aria-label="Mode switch">
        <div class="seg" role="tablist" aria-label="Basic or Full mode">
          <button id="btnBasic" type="button" class="active" role="tab" aria-selected="true">Basic</button>
          <button id="btnFull" type="button" role="tab" aria-selected="false">Full</button>
        </div>
      </div>

      <div class="pillRow">
        <span class="pill" id="dayChip"></span>
        <span class="pill" id="shiftChip">Shift: —</span>
        <span class="pill" id="viewChip">View: Basic</span>
        <span class="pill" id="modePill">
          <span class="dot" id="modeDot"></span>
          <span id="modeText">Not started</span>
        </span>
      </div>
    </div>
  </header>

  <div class="wrap">
    <main class="grid">

      <section class="card" aria-label="Shift controls">
        <h3>Shift controls</h3>
        <div class="row">
          <button class="btn primary" id="btnStart">Start shift</button>
          <button class="btn secondary" id="btnEnd">End shift</button>
          <button class="btn danger" id="btnReset">Reset day</button>
        </div>
        <div class="tiny" style="margin-top:10px">
          Basic mode: clean tracking. Full mode: alerts + log + manual fixes.
        </div>
      </section>

      <section class="banner" id="statusBanner" aria-live="polite" aria-label="Status">
        <div style="padding-left:10px">
          <div><b>Status:</b> <span id="statusText" class="statusGood">Ready</span></div>
          <div class="muted" id="statusDetail">Start a shift to begin tracking.</div>
        </div>
        <div style="text-align:right">
          <div class="muted">Shift time</div>
          <div class="big timer" id="shiftElapsed">00:00</div>
        </div>
      </section>

      <section class="card" id="heroCard" aria-label="Live tracking">
        <h3>Live</h3>
        <div class="row" style="align-items:flex-end">
          <div style="flex:1 1 240px">
            <div class="muted">Continuous work</div>
            <div class="big2 timer" id="heroContWork">00:00</div>
          </div>
          <div style="flex:1 1 240px;text-align:right">
            <div class="muted">Next break in</div>
            <div class="big2 timer" id="heroNextBreakIn">—</div>
          </div>
        </div>
        <div class="tiny" id="heroHint" style="margin-top:10px">
          Qualifying break = BREAK mode for ≥15 minutes. (6:00 continuous-work rule)
        </div>
      </section>

      <section class="cards" aria-label="Totals">
        <div class="card">
          <h3>Working time</h3>
          <div class="big2 timer" id="workTotal">00:00</div>
          <div class="muted">Total WORK time</div>
        </div>

        <div class="card">
          <h3>Qualifying breaks</h3>
          <div class="big2 timer" id="qBreakTotal">00:00</div>
          <div class="muted">BREAK segments ≥ 15 min</div>
        </div>

        <div class="card">
          <h3>6h interrupt countdown</h3>
          <div class="big2 timer" id="interruptCountdown">—</div>
          <div class="muted">5:45 alert on. 6:00 required.</div>
        </div>

        <div class="card">
          <h3>Break still needed</h3>
          <div class="big2 timer" id="breakNeeded">00:00</div>
          <div class="muted" id="breakRule">—</div>
        </div>
      </section>

      <!-- FULL MODE ONLY -->
      <section class="card fullOnly" aria-label="Alerts">
        <h3>Alerts</h3>
        <div class="row">
          <label class="pill" style="gap:10px;">
            <input type="checkbox" id="audibleOn" />
            Audible
          </label>
          <label class="pill" style="gap:10px;">
            <input type="checkbox" id="vibrateOn" />
            Vibration
          </label>
        </div>
        <div class="tiny" style="margin-top:8px">
          iPhone: vibration/audio can be limited. For sound, you may need to tap once after opening the page.
        </div>
      </section>

      <section class="card fullOnly" aria-label="Log">
        <h3>Log (today)</h3>
        <div class="row" style="margin-bottom:10px">
          <button class="btn secondary" id="btnUndo">Undo last</button>
          <button class="btn secondary" id="btnCloseSegment">Close current segment</button>
        </div>
        <div style="overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,.06)">
          <table aria-label="Segments log">
            <thead>
              <tr>
                <th>From</th><th>To</th><th>Mode</th>
                <th class="right">Mins</th><th class="right">Qualifies?</th>
              </tr>
            </thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>
        <div class="tiny" style="margin-top:8px">
          Qualifying break = a BREAK segment of <b>15 minutes or longer</b>.
        </div>
      </section>

      <section class="card fullOnly" aria-label="Manual tools">
        <h3>Manual tools</h3>
        <div class="tiny">If you forgot to tap, add/overwrite segments below.</div>

        <div class="field">
          <label for="manualMode">Add a segment</label>
          <select id="manualMode">
            <option value="WORK">Work</option>
            <option value="BREAK">Break</option>
          </select>
        </div>

        <div class="field">
          <label for="manualFrom">Start time</label>
          <input type="time" id="manualFrom" />
        </div>

        <div class="field">
          <label for="manualTo">End time</label>
          <input type="time" id="manualTo" />
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn secondary" id="btnAddSegment">Add segment</button>
          <button class="btn secondary" id="btnEditLast">Overwrite last segment</button>
        </div>

        <div class="tiny" style="margin-top:8px">
          “Add segment” inserts a closed block. “Overwrite last” replaces the most recent closed segment.
        </div>
      </section>

    </main>
  </div>

  <!-- Emergency break overlay (shows only when break is DUE) -->
  <div id="emergencyOverlay" aria-hidden="true">
    <div class="emCard" role="dialog" aria-modal="true" aria-label="Break required">
      <div class="emTitle">BREAK REQUIRED NOW</div>
      <div class="emSub">You’ve reached 6:00 continuous work.</div>

      <div class="emStats">
        <div>
          <div class="emLabel">Continuous work</div>
          <div class="emValue timer" id="emContWork">00:00</div>
        </div>
        <div style="text-align:right">
          <div class="emLabel">Minimum break</div>
          <div class="emValue timer">15 mins</div>
        </div>
      </div>

      <button class="emBreakBtn" id="btnEmergencyBreak" type="button">
        START BREAK
      </button>

      <div class="emHint">This is a beta app — times must be double checked.</div>
    </div>
  </div>

  <div class="footer" aria-label="Quick actions">
    <div class="row">
      <!-- CHANGED: both are “secondary glass”; green selection overrides; red only on overdue -->
      <button class="btn WORK secondary" id="btnWork" type="button">Work</button>
      <button class="btn BREAK secondary" id="btnBreak" type="button">Break</button>
    </div>
    <div class="tiny footerNote">
      Basic is clean. Full has alerts + log + manual fixes.
    </div>
  </div>

  <script>
    (() => {
      const STORAGE_KEY = "wtd_tracker_work_break_full_v5";

      const QUALIFY_BREAK_MIN = 15;
      const INTERRUPT_LIMIT_MIN = 360; // 6 hours continuous work
      const SOON_AT_MIN = 345;         // 5h45 warning
      const ALERT_COOLDOWN_MS = 10 * 60 * 1000;

      const $ = (id) => document.getElementById(id);
      const now = () => Date.now();

      const fmtHM = (mins) => {
        mins = Math.max(0, Math.floor(mins));
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        return String(h).padStart(2,"0") + ":" + String(m).padStart(2,"0");
      };

      const fmtTime = (ms) => {
        if (!ms) return "—";
        const d = new Date(ms);
        return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      };

      const todayLabel = () => {
        const d = new Date();
        return d.toLocaleDateString([], {weekday:"short", year:"numeric", month:"short", day:"2-digit"});
      };

      const minutesBetween = (a,b) => Math.max(0, Math.floor((b - a) / 60000));

      let state = {
        shiftStart: null,
        shiftEnd: null,
        currentMode: null, // "WORK" | "BREAK"
        currentFrom: null,
        segments: [],      // closed: {mode, from, to}
        alerts: { audible: false, vibrate: false },
        view: "basic"      // "basic" | "full"
      };

      const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      const load = () => {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try { state = JSON.parse(raw); } catch {}
      };

      // ===== Alerts =====
      let lastAlertKey = "";
      let lastAlertAt = 0;

      const beep = () => {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = "sine";
          o.frequency.value = 880;
          g.gain.value = 0.05;
          o.connect(g); g.connect(ctx.destination);
          o.start();
          setTimeout(() => { o.stop(); ctx.close(); }, 220);
        } catch {}
      };

      const vibrate = (pattern) => {
        try { if (navigator.vibrate) navigator.vibrate(pattern); } catch {}
      };

      const triggerAlert = (key) => {
        const t = now();
        if (key === lastAlertKey && (t - lastAlertAt) < ALERT_COOLDOWN_MS) return;
        lastAlertKey = key;
        lastAlertAt = t;
        if (state.alerts.audible) beep();
        if (state.alerts.vibrate) vibrate([200, 120, 200]);
      };

      // ===== Segment handling =====
      const closeCurrent = (t = now()) => {
        if (!state.shiftStart || !state.currentMode || !state.currentFrom) return;
        if (t <= state.currentFrom) return;
        state.segments.push({ mode: state.currentMode, from: state.currentFrom, to: t });
        state.currentFrom = t;
        save();
      };

      const setMode = (mode) => {
        if (!state.shiftStart || state.shiftEnd) return;
        const t = now();
        if (!state.currentMode) {
          state.currentMode = mode;
          state.currentFrom = t;
          save(); render();
          return;
        }
        closeCurrent(t);
        state.currentMode = mode;
        save(); render();
      };

      const startShift = () => {
        const t = now();
        state.shiftStart = t;
        state.shiftEnd = null;
        state.currentMode = "WORK";
        state.currentFrom = t;
        state.segments = [];
        lastAlertKey = "";
        lastAlertAt = 0;
        save(); render();
      };

      const endShift = () => {
        if (!state.shiftStart || state.shiftEnd) return;
        const t = now();
        closeCurrent(t);
        state.shiftEnd = t;
        state.currentMode = null;
        state.currentFrom = null;
        save(); render();
      };

      const resetDay = () => {
        state.shiftStart = null;
        state.shiftEnd = null;
        state.currentMode = null;
        state.currentFrom = null;
        state.segments = [];
        lastAlertKey = "";
        lastAlertAt = 0;
        save(); render();
      };

      const undoLast = () => {
        if (!state.segments.length) return;
        state.segments.pop();
        lastAlertKey = "";
        lastAlertAt = 0;
        save(); render();
      };

      const getAllSegmentsIncludingOpen = () => {
        const out = [...state.segments];
        if (state.shiftStart && !state.shiftEnd && state.currentMode && state.currentFrom) {
          out.push({ mode: state.currentMode, from: state.currentFrom, to: now(), open:true });
        }
        return out;
      };

      const compute = () => {
        const segs = getAllSegmentsIncludingOpen();

        let workMin = 0;
        let breakMinQual = 0;
        let contWorkMin = 0;

        for (const s of segs) {
          const m = minutesBetween(s.from, s.to);

          if (s.mode === "WORK") {
            workMin += m;
            contWorkMin += m;
          } else if (s.mode === "BREAK") {
            if (m >= QUALIFY_BREAK_MIN) {
              breakMinQual += m;
              contWorkMin = 0;
            }
          }
        }

        // Per your rule:
        // - After >6 hours total WORK: 30 mins total qualifying breaks required
        // - After >9 hours total WORK: an additional 15 mins qualifying break required (i.e., +15)
        let requiredMin = 0;
        if (workMin > 360) requiredMin = 30;
        if (workMin > 540) requiredMin = 45;

        const neededMin = Math.max(0, requiredMin - breakMinQual);

        // Shift elapsed
        let shiftElapsedMin = 0;
        if (state.shiftStart) {
          const end = state.shiftEnd ?? now();
          shiftElapsedMin = minutesBetween(state.shiftStart, end);
        }

        // 6h continuous-work rule
        const remainingInterruptMin = state.shiftStart ? Math.max(0, INTERRUPT_LIMIT_MIN - contWorkMin) : null;

        return {
          workMin,
          breakMinQual,
          contWorkMin,
          requiredMin,
          neededMin,
          shiftElapsedMin,
          remainingInterruptMin
        };
      };

      // Manual tools
      const parseTimeToMsToday = (hhmm) => {
        if (!hhmm) return null;
        const [h, m] = hhmm.split(":").map(Number);
        if (Number.isNaN(h) || Number.isNaN(m)) return null;
        const d = new Date();
        d.setHours(h, m, 0, 0);
        return d.getTime();
      };

      const addSegmentManual = (overwriteLast=false) => {
        if (!state.shiftStart) return;
        const mode = $("manualMode").value;
        const fromMs = parseTimeToMsToday($("manualFrom").value);
        const toMs = parseTimeToMsToday($("manualTo").value);
        if (!fromMs || !toMs || toMs <= fromMs) return;

        if (!state.shiftEnd) closeCurrent(now());

        if (overwriteLast && state.segments.length) state.segments.pop();
        state.segments.push({ mode, from: fromMs, to: toMs });
        state.segments.sort((a,b) => a.from - b.from);

        lastAlertKey = "";
        lastAlertAt = 0;
        save(); render();
      };

      const applyView = (view) => {
        state.view = view;
        document.body.classList.toggle("full", view === "full");

        $("btnBasic").classList.toggle("active", view === "basic");
        $("btnFull").classList.toggle("active", view === "full");
        $("btnBasic").setAttribute("aria-selected", view === "basic" ? "true" : "false");
        $("btnFull").setAttribute("aria-selected", view === "full" ? "true" : "false");

        $("viewChip").textContent = "View: " + (view === "full" ? "Full" : "Basic");
        save();
        render();
      };

      const setBodyState = (klass) => {
        document.body.classList.remove("state-ok","state-warn","state-alert");
        document.body.classList.add(klass);
      };

      const render = () => {
        $("dayChip").textContent = todayLabel();

        // Mode pill + shift chip
        if (!state.shiftStart) {
          $("modeText").textContent = "Not started";
          $("modeDot").className = "dot";
          $("shiftChip").textContent = "Shift: —";
        } else if (state.shiftEnd) {
          $("modeText").textContent = "Ended";
          $("modeDot").className = "dot";
          $("shiftChip").textContent = `Shift: ${fmtTime(state.shiftStart)}–${fmtTime(state.shiftEnd)}`;
        } else {
          $("modeText").textContent = state.currentMode || "—";
          $("modeDot").className = "dot " + (state.currentMode || "");
          $("shiftChip").textContent = `Shift: ${fmtTime(state.shiftStart)}–…`;
        }

        // Full-mode toggles (keep in sync even if hidden)
        $("audibleOn").checked = !!state.alerts.audible;
        $("vibrateOn").checked = !!state.alerts.vibrate;

        const c = compute();

        $("workTotal").textContent = fmtHM(c.workMin);
        $("qBreakTotal").textContent = fmtHM(c.breakMinQual);
        $("shiftElapsed").textContent = fmtHM(c.shiftElapsedMin);

        // Live values
        $("heroContWork").textContent = fmtHM(c.contWorkMin);

        // Next break countdown (6:00 continuous-work rule)
        if (!state.shiftStart || state.shiftEnd) {
          $("heroNextBreakIn").textContent = "—";
          $("interruptCountdown").textContent = "—";
          $("heroHint").textContent = "Start a shift to begin live tracking.";
        } else if (state.currentMode === "BREAK") {
          $("heroNextBreakIn").textContent = "On break";
          $("interruptCountdown").textContent = "On break";
          $("heroHint").textContent = "Qualifying break = ≥15 minutes.";
        } else {
          const rem = c.remainingInterruptMin ?? null;
          const remText = (rem === 0) ? "DUE NOW" : fmtHM(rem);
          $("heroNextBreakIn").textContent = remText;
          $("interruptCountdown").textContent = remText;
          $("heroHint").textContent = "Qualifying break = BREAK mode for ≥15 minutes. (6:00 continuous-work rule)";
        }

        // Break totals rule text (your 9h rule wording)
        if (!state.shiftStart) {
          $("breakRule").textContent = "—";
        } else {
          if (c.workMin > 540) {
            $("breakRule").textContent = "After 9h total WORK: +15 mins qualifying break required (total 45).";
          } else if (c.workMin > 360) {
            $("breakRule").textContent = "After 6h total WORK: 30 mins qualifying break required.";
          } else {
            $("breakRule").textContent = "No total-break target yet (but don’t exceed 6h continuous work).";
          }
        }
        $("breakNeeded").textContent = fmtHM(c.neededMin);

        // Emergency overlay live value
        $("emContWork").textContent = fmtHM(c.contWorkMin);

        // ===== Status + smarter alerts + UI state =====
        const status = $("statusText");
        const detail = $("statusDetail");

        const onBreakNow = (state.currentMode === "BREAK");
        const interruptDue = (c.contWorkMin >= INTERRUPT_LIMIT_MIN);
        const interruptSoon = (c.contWorkMin >= SOON_AT_MIN);
        const totalShort = (c.workMin > 360 && c.neededMin > 0);

        let uiState = "state-ok";

        if (!state.shiftStart) {
          status.textContent = "Ready";
          status.className = "statusGood";
          detail.textContent = "Start a shift to begin tracking.";
          uiState = "state-ok";
          lastAlertKey = "";
          lastAlertAt = 0;
        }
        else if (state.shiftEnd) {
          status.textContent = "Shift ended";
          status.className = "statusGood";
          detail.textContent = "Done.";
          uiState = "state-ok";
          lastAlertKey = "";
          lastAlertAt = 0;
        }
        else if (onBreakNow) {
          status.textContent = "On break";
          status.className = "statusGood";
          detail.textContent = "Qualifying break = ≥15 minutes.";
          uiState = "state-ok";
        }
        else if (interruptDue) {
          status.textContent = "Break required now (≥15m)";
          status.className = "statusBad";
          detail.textContent = "You’ve reached 6:00 continuous working time.";
          uiState = "state-alert";
          triggerAlert("interrupt_due");
        }
        else if (interruptSoon) {
          status.textContent = "Break soon";
          status.className = "statusWarn";
          detail.textContent = "5:45 continuous work — plan a ≥15m break.";
          uiState = "state-warn";
          triggerAlert("interrupt_soon");
        }
        else if (totalShort) {
          status.textContent = "More qualifying breaks needed";
          status.className = "statusWarn";
          detail.textContent = "You are short on total qualifying breaks for your total WORK time.";
          uiState = "state-warn";
          const band = (c.workMin > 540) ? "45" : "30";
          triggerAlert("total_short_" + band);
        }
        else {
          status.textContent = "Compliant so far";
          status.className = "statusGood";
          detail.textContent = "Tracking OK.";
          uiState = "state-ok";
        }

        setBodyState(uiState);

        // Emergency overlay aria-hidden
        const overlay = $("emergencyOverlay");
        overlay.setAttribute("aria-hidden", uiState === "state-alert" ? "false" : "true");

        // ===== NEW: Green selection on footer buttons (hard override) =====
        const inShift = !!state.shiftStart && !state.shiftEnd;
        $("btnWork").classList.toggle("modeSelected", inShift && state.currentMode === "WORK");
        $("btnBreak").classList.toggle("modeSelected", inShift && state.currentMode === "BREAK");

        // Optional accessibility: reflect current pressed state
        $("btnWork").setAttribute("aria-pressed", (inShift && state.currentMode === "WORK") ? "true" : "false");
        $("btnBreak").setAttribute("aria-pressed", (inShift && state.currentMode === "BREAK") ? "true" : "false");

        // Log table (full view only)
        const tbody = $("logBody");
        tbody.innerHTML = "";
        if (state.view === "full") {
          const segs = [...state.segments];
          if (state.shiftStart && !state.shiftEnd && state.currentMode && state.currentFrom) {
            segs.push({ mode: state.currentMode, from: state.currentFrom, to: now(), open:true });
          }
          for (const s of segs) {
            const m = minutesBetween(s.from, s.to);
            const qualifies = (s.mode === "BREAK" && m >= QUALIFY_BREAK_MIN) ? "Yes" :
                              (s.mode === "BREAK") ? "No" : "—";
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${fmtTime(s.from)}</td>
              <td>${s.open ? "…" : fmtTime(s.to)}</td>
              <td>${s.mode}</td>
              <td class="right">${m}</td>
              <td class="right">${qualifies}</td>
            `;
            tbody.appendChild(tr);
          }
        }
      };

      // ===== Wire up UI =====
      $("btnStart").addEventListener("click", startShift);
      $("btnEnd").addEventListener("click", endShift);
      $("btnReset").addEventListener("click", resetDay);

      $("btnWork").addEventListener("click", () => setMode("WORK"));
      $("btnBreak").addEventListener("click", () => setMode("BREAK"));
      $("btnEmergencyBreak").addEventListener("click", () => setMode("BREAK"));

      $("btnUndo").addEventListener("click", undoLast);
      $("btnCloseSegment").addEventListener("click", () => { closeCurrent(now()); render(); });

      $("btnAddSegment").addEventListener("click", () => addSegmentManual(false));
      $("btnEditLast").addEventListener("click", () => addSegmentManual(true));

      $("audibleOn").addEventListener("change", (e) => { state.alerts.audible = e.target.checked; save(); });
      $("vibrateOn").addEventListener("change", (e) => { state.alerts.vibrate = e.target.checked; save(); });

      $("btnBasic").addEventListener("click", () => applyView("basic"));
      $("btnFull").addEventListener("click", () => applyView("full"));

      // ===== Init =====
      load();
      state.alerts = state.alerts || { audible:false, vibrate:false };
      state.view = state.view || "basic";
      applyView(state.view);
      render();
      setInterval(render, 5000);
    })();
  </script>
</body>
</html>
